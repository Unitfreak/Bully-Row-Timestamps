<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
            margin: 0;
            padding: 0;
            flex-direction: column;
        }

        h2 {
            color: #444;
        }

        h1 {
            color: #666;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .timezone-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .timezone-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timezone-item label {
            margin-right: 10px;
        }
    </style>
</head>

<body onload="initTimestamps()">

  <h2>Bully Timestamp:

  <select id="bullytime">
    <option value="1">+ Seconds</option>
    <option value="2">+ Percent</option>
    <option value="3">+ Timepan</option>
    <option value="4">+ Hex</option>
  </select>

  </h2>

  <div id="txt">Calculating...</div>
  
  <div class="timezone-container">
      <h3>Compare Timezones:</h3>
      <div id="timezone-displays"></div>
  </div>
  
  <a href="https://en.m.wikiversity.org/wiki/Bully_Timestamps" style="padding-top: 15px;">Learn how it works!</a>
	
  <script>
  const bullysellect = document.getElementById("bullytime");
  
  const TAI_UTC_OFFSET_SECONDS = 37; // Current hardcoded offset
  const TT_TAI_OFFSET_SECONDS = 32.184; // Constant offset between TT and TAI
  
  const timezones = [
      { id: "tz-1", name: "Time Zone 1", default: "America/New_York" },
      { id: "tz-2", name: "Time Zone 2", default: "Europe/London" },
      { id: "tz-3", name: "Time Zone 3", default: "Asia/Tokyo" },
      { id: "tz-4", name: "Time Zone 4", default: "Australia/Sydney" }
  ];

  const fullTimeZoneList = [
      {value: "America/New_York", label: "America/New_York"},
      {value: "America/Los_Angeles", label: "America/Los_Angeles"},
      {value: "America/Chicago", label: "America/Chicago"},
      {value: "Europe/London", label: "Europe/London"},
      {value: "Europe/Paris", label: "Europe/Paris"},
      {value: "Europe/Berlin", label: "Europe/Berlin"},
      {value: "Asia/Tokyo", label: "Asia/Tokyo"},
      {value: "Asia/Shanghai", label: "Asia/Shanghai"},
      {value: "Asia/Dubai", label: "Asia/Dubai"},
      {value: "Australia/Sydney", label: "Australia/Sydney"},
      {value: "Australia/Perth", label: "Australia/Perth"},
      {value: "Pacific/Auckland", label: "Pacific/Auckland"},
      {value: "UTC", label: "UTC"},
      {value: "TAI", label: "International Atomic Time"},
      {value: "TT", label: "Terrestrial Time"}
  ];

  // Custom function to format a Date object with both date and time
  function formatTimeWithDate(date, timezone) {
    const options = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: timezone
    };
    return date.toLocaleString('en-US', options);
  }
  
  function createTimeZoneSelectors() {
    const container = document.getElementById('timezone-displays');
    timezones.forEach(tz => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'timezone-item';
        
        const label = document.createElement('label');
        label.textContent = tz.name + ":";
        
        const select = document.createElement('select');
        select.id = `select-${tz.id}`;
        
        fullTimeZoneList.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.value;
            option.textContent = zone.label;
            if (zone.value === tz.default) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        const displayDiv = document.createElement('div');
        displayDiv.id = `display-${tz.id}`;
        displayDiv.style.marginLeft = '10px';
        displayDiv.textContent = 'Loading...';
        
        itemDiv.appendChild(label);
        itemDiv.appendChild(select);
        itemDiv.appendChild(displayDiv);
        container.appendChild(itemDiv);
    });
  }
  
  function updateTimestamps() {
    const now = new Date();
    const Pta_per_ms = 1/30550;
    const Jun_21_1998_noon_UTC = 898430400000;
    const TAI_leap_milliseconds = 37000; // Hardcoded, as per original version
    const anchor_byte3 = parseInt("8209", 16);
    const anchor_byte2 = parseInt("2800", 16);
    const anchor_byte1 = parseInt("0000", 16);

    let ms_raw = now.getTime();
    let ms_fix = (ms_raw - (Jun_21_1998_noon_UTC - TAI_leap_milliseconds));
    let Pta_raw = Math.round(ms_fix * Pta_per_ms * 1000) / 1000;

    let Tta_txt = "";
    let Pta_txt = "";

    if (bullysellect.value == 1) {
	    Tta_txt = Math.floor((ms_fix / 100) % 10).toString().padStart(1, '0') + " sec)";
      Pta_txt = Math.floor((ms_fix / 1000) % 3055).toString().padStart(1, '0') + ".";
    }

    if (bullysellect.value == 2) {
	    Tta_txt = Math.floor((Pta_raw * 1000) % 1000).toString().padStart(3, '0') + " %)";
      Pta_txt = Math.floor(Pta_raw % 100).toString().padStart(2, '0') + ".";
    }

    if (bullysellect.value == 3) {
	    Tta_txt = Math.floor((Pta_raw * 1000) % 1000).toString().padStart(3, '0') + " Tta)";
      Pta_txt = Math.floor(Pta_raw % 100).toString().padStart(2, '0') + " Pta ";
    }

    if (bullysellect.value == 4) {
	    Tta_txt = Math.floor(((Pta_raw / 100) * 16**4) %16**4).toString(16).toUpperCase().padStart(4, '0') + " hex)";
      Pta_txt = "";
    }

    let Pta_dec = ((Pta_raw % 100) + 100) % 100;
    Pta = ((Pta_raw - Pta_dec) / 100) + anchor_byte1;

    let Pta_hex1 = ((Pta % 16**4) + 16**4) % 16**4;
    Pta = ((Pta - Pta_hex1) / 16**4) + anchor_byte2;

    let Pta_hex2 = ((Pta % 16**4) + 16**4) % 16**4;
    let Pta_hex3 = ((Pta - Pta_hex2) / 16**4) + anchor_byte3;

    document.getElementById('txt').innerHTML =  "<h1>" 
        + Pta_hex3.toString(16).toUpperCase().padStart(4, "0") 
        + " " + Pta_hex2.toString(16).toUpperCase().padStart(4, "0") 
        + " " + Pta_hex1.toString(16).toUpperCase().padStart(4, "0")
        + " <small>(+ " + Pta_txt + Tta_txt
        + "</small></h1>";

    // Update each user-selected time zone
    timezones.forEach(tz => {
        const select = document.getElementById(`select-${tz.id}`);
        const display = document.getElementById(`display-${tz.id}`);
        const selectedTimezone = select.value;

        if (selectedTimezone === 'TAI') {
            const taiTime = new Date(now.getTime() + TAI_UTC_OFFSET_SECONDS * 1000);
            display.textContent = `${formatTimeWithDate(taiTime, 'UTC')} (TAI)`;
        } else if (selectedTimezone === 'TT') {
            const taiTime = new Date(now.getTime() + TAI_UTC_OFFSET_SECONDS * 1000);
            const ttTime = new Date(taiTime.getTime() + TT_TAI_OFFSET_SECONDS * 1000);
            display.textContent = `${formatTimeWithDate(ttTime, 'UTC')} (TT)`;
        } else {
            display.textContent = formatTimeWithDate(now, selectedTimezone);
        }
    });
    
    setTimeout(updateTimestamps, 30);
  }
  
  function initTimestamps() {
    createTimeZoneSelectors();
    updateTimestamps();
  }
  </script>
</body>
</html>
