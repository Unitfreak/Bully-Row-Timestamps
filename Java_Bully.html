<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80vh;
            margin: 0;
            padding: 0;
            flex-direction: column;
        }

        h2 {
            color: #444;
        }

        h1 {
            color: #666;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .timezone-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .timezone-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timezone-item label {
            margin-right: 10px;
        }
        
        #user-time-input {
            display: none; /* Hidden by default */
        }
    </style>
</head>

<body onload="initTimestamps()">

  <h2>Bully Timestamp:

  <select id="bullytime">
    <option value="1">+ Seconds</option>
    <option value="2">+ Percent</option>
    <option value="3">+ Timepan</option>
    <option value="4">+ Hex</option>
  </select>

  <select id="time-mode-select">
    <option value="current">Current Time</option>
    <option value="user-selected">User Selected Time</option>
  </select>

  </h2>

  <div id="txt">Calculating...</div>
  <input type="datetime-local" id="user-time-input" step="0.1">

  <div class="timezone-container">
      <h3>Compare Timezones:</h3>
      <div id="timezone-displays"></div>
  </div>
  
  <a href="https://en.m.wikiversity.org/wiki/Bully_Timestamps" style="padding-top: 15px;">Learn how it works!</a>
	
  <script>
  const bullysellect = document.getElementById("bullytime");
  const timeModeSelect = document.getElementById("time-mode-select");
  const userTimeInput = document.getElementById("user-time-input");
  let animationFrameId = null; // Use for requestAnimationFrame
  const TT_TAI_OFFSET_MILLISECONDS = 32184; // Constant offset between TT and TAI
  const leapSeconds = [
   new Date("1972-01-01T00:00:01Z"),
   new Date("1972-07-01T00:00:01Z"),
   new Date("1973-01-01T00:00:01Z"),
   new Date("1974-01-01T00:00:01Z"),
   new Date("1975-01-01T00:00:01Z"),
   new Date("1976-01-01T00:00:01Z"),
   new Date("1977-01-01T00:00:01Z"),
   new Date("1978-01-01T00:00:01Z"),
   new Date("1979-01-01T00:00:01Z"),
   new Date("1980-01-01T00:00:01Z"),
   new Date("1981-07-01T00:00:01Z"),
   new Date("1982-07-01T00:00:01Z"),
   new Date("1983-07-01T00:00:01Z"),
   new Date("1985-07-01T00:00:01Z"),
   new Date("1988-01-01T00:00:01Z"),
   new Date("1990-01-01T00:00:01Z"),
   new Date("1991-01-01T00:00:01Z"),
   new Date("1992-07-01T00:00:01Z"),
   new Date("1993-07-01T00:00:01Z"),
   new Date("1994-07-01T00:00:01Z"),
   new Date("1996-01-01T00:00:01Z"),
   new Date("1997-07-01T00:00:01Z"),
   new Date("1999-01-01T00:00:01Z"),
   new Date("2006-01-01T00:00:01Z"),
   new Date("2009-01-01T00:00:01Z"),
   new Date("2012-07-01T00:00:01Z"),
   new Date("2015-07-01T00:00:01Z"),
   new Date("2017-01-01T00:00:01Z"),
  ];
  const rubberSeconds = [
   new Date("1957-12-31T23:13:00.003Z"),
   new Date("1959-12-31T23:38:29.057Z"),
   new Date("1960-12-31T23:36:53.577Z"),
   new Date("1960-12-31T23:36:53.577Z"),
   new Date("1961-07-31 23:53:13.302Z"),
   new Date("1961-07-31 23:53:13.352Z"),
   new Date("1961-12-31 23:49:38.154Z"),
   new Date("1963-10-31 23:32:57.303Z"),
   new Date("1963-10-31 23:32:57.303Z"),
   new Date("1963-12-31 23:24:12.234Z"),
   new Date("1964-03-31 23:43:42.016Z"),
   new Date("1964-03-31 23:43:42.016Z"),
   new Date("1964-08-31 23:40:06.718Z"),
   new Date("1964-08-31 23:40:06.718Z"),
   new Date("1964-12-31 23:22:36.460Z"),
   new Date("1964-12-31 23:22:36.460Z"),
   new Date("1965-02-28 23:42:31.283Z"),
   new Date("1965-02-28 23:42:31.283Z"),
   new Date("1965-06-30 23:25:01.025Z"),
   new Date("1965-06-30 23:25:01.025Z"),
   new Date("1965-08-31 23:52:50.845Z"),
   new Date("1965-08-31 23:52:50.845Z"),
   new Date("1965-12-31 23:35:20.687Z"),
   new Date("1968-01-31 23:23:48.714Z"),
   new Date("1968-01-31 23:23:48.814Z"),
   new Date("1971-12-31T23:46:30.108Z"),
   new Date("1971-12-31T23:46:30.108Z"),
   new Date("1972-01-01T00:00:01Z"),
  ];
  const rubberValues = [
    -0.002598,
     0.943482,
     1.417818,
     1.422818,
     1.69757,
     1.64757,
     1.845858,
     2.5972788,
     2.6972788,
     2.765794,
     2.88373,
     2.98373,
     3.182018,
     3.282018,
     3.44013,
     3.54013,
     3.616594,
     3.716594,
     3.874706,
     3.974706,
     4.055058,
     4.155058,
     4.31317,
     6.285682,
     6.185682,
     9.892242,
     10,
     10,
  ]
   

  function calcLeapSeconds(thisTime) {
      let leapS;
      if (thisTime.getTime() > leapSeconds[0].getTime()) {
        leapS = 10 + findNearestIndex(leapSeconds, thisTime);
      } else if (thisTime.getTime() > rubberSeconds[0].getTime()) {
         firstIndex = findNearestIndex(rubberSeconds, thisTime);
         secondIndex = firstIndex + 1;
         RF = (thisTime - rubberSeconds[firstIndex]) / (rubberSeconds[secondIndex] - rubberSeconds[firstIndex]);
         leapS = ((1-RF)*rubberValues[firstIndex]) + (RF * rubberValues[secondIndex])
      } else {
          leapS = 0
      }
      return leapS;
  }

  function findNearestIndex(times, thisTime) {    
    const topIndex = times.length - 1;
    const topI = Math.floor(Math.log2(topIndex));      
    let midIndex = Math.ceil(topIndex / 2);
    let offIndex = Math.ceil(midIndex / 2);
    for (let i = 0; i < topI; i++) {
      if (thisTime.getTime() > times[midIndex].getTime()) {
        midIndex = midIndex + offIndex;
        if (midIndex > topIndex) {
          midIndex = topIndex
        }
      }
      if (thisTime.getTime() < times[midIndex].getTime()) {
        midIndex = midIndex - offIndex;
          if (midIndex < 0) {
            midIndex = 0
          }
      }
      offIndex = Math.ceil(offIndex / 2);
    }
    return midIndex;
  }

  function openOfficeMod(dividend, divisor) {
    let remainder = dividend % divisor;
    if ((remainder < 0 && divisor > 0) || (remainder > 0 && divisor < 0)) {
      remainder += divisor;
    }
    return remainder;
  }     
  
  const timezones = [
      { id: "tz-1", name: "Time Zone 1", default: "America/New_York" },
      { id: "tz-2", name: "Time Zone 2", default: "Europe/London" },
      { id: "tz-3", name: "Time Zone 3", default: "Asia/Tokyo" },
      { id: "tz-4", name: "Time Zone 4", default: "Australia/Sydney" }
  ];

  const fullTimeZoneList = [
      {value: "America/New_York", label: "America/New_York"},
      {value: "America/Los_Angeles", label: "America/Los_Angeles"},
      {value: "America/Chicago", label: "America/Chicago"},
      {value: "Europe/London", label: "Europe/London"},
      {value: "Europe/Paris", label: "Europe/Paris"},
      {value: "Europe/Berlin", label: "Europe/Berlin"},
      {value: "Asia/Tokyo", label: "Asia/Tokyo"},
      {value: "Asia/Shanghai", label: "Asia/Shanghai"},
      {value: "Asia/Dubai", label: "Asia/Dubai"},
      {value: "Australia/Sydney", label: "Australia/Sydney"},
      {value: "Australia/Perth", label: "Australia/Perth"},
      {value: "Pacific/Auckland", label: "Pacific/Auckland"},
      {value: "UTC", label: "UTC"},
      {value: "TAI", label: "International Atomic Time"},
      {value: "TT", label: "Terrestrial Time"}
  ];

  // Custom function to format a Date object with both date and time
  function formatTimeWithDate(date, timezone, u12hr, FSDigits) {
    const options = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour12: u12hr,   
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      fractionalSecondDigits: FSDigits,
      timeZone: timezone
    };
    return date.toLocaleString('en-US', options);
  }
  
  function createTimeZoneSelectors() {
    const container = document.getElementById('timezone-displays');
    timezones.forEach(tz => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'timezone-item';
        
        const label = document.createElement('label');
        label.textContent = tz.name + ":";
        
        const select = document.createElement('select');
        select.id = `select-${tz.id}`;
        
        fullTimeZoneList.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.value;
            option.textContent = zone.label;
            if (zone.value === tz.default) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        const displayDiv = document.createElement('div');
        displayDiv.id = `display-${tz.id}`;
        displayDiv.style.marginLeft = '10px';
        displayDiv.textContent = 'Loading...';
        
        itemDiv.appendChild(label);
        itemDiv.appendChild(select);
        itemDiv.appendChild(displayDiv);
        container.appendChild(itemDiv);
    });
  }
  
  function updateTimestamps() {
    let now;
    let fracSecDig;
    if (timeModeSelect.value === "current") {
        now = new Date();
        fracSecDig = 1;
         use12hr = true;
    } else {
        const userTimeValue = userTimeInput.value;
        if (userTimeValue) {
            now = new Date(userTimeValue + 'Z');
            fracSecDig = 3;
            use12hr = false;
        } else {
            document.getElementById('txt').innerHTML = "<h1>Please select a time.</h1>";
            return;
        }
    }

    const TAI_UTC_OFFSET_MILLISECONDS = 1000 * calcLeapSeconds(now);

    const Pta_per_ms = 1/30550;
    const Jun_21_1998_noon_UTC = 898430400000;
    const anchor_byte3 = parseInt("8209", 16);
    const anchor_byte2 = parseInt("2800", 16);
    const anchor_byte1 = parseInt("0000", 16);

    let ms_raw = now.getTime();
    let ms_fix = (ms_raw - Jun_21_1998_noon_UTC) + TAI_UTC_OFFSET_MILLISECONDS;
    let Pta_raw = Math.round(ms_fix * Pta_per_ms * 1000) / 1000;

    let Tta_txt = "";
    let Pta_txt = "";

    if (bullysellect.value == 1) {
	    Tta_txt = Math.floor(openOfficeMod(ms_fix / 100, 10)).toString().padStart(1, '0') + " sec)";
      Pta_txt = Math.floor(openOfficeMod(ms_fix / 1000, 3055)).toString().padStart(1, '0') + ".";
    }

    if (bullysellect.value == 2) {
	    Tta_txt = Math.floor(openOfficeMod(Pta_raw * 1000, 1000)).toString().padStart(3, '0') + " %)";
      Pta_txt = Math.floor(openOfficeMod(Pta_raw, 100)).toString().padStart(2, '0') + ".";
    }

    if (bullysellect.value == 3) {
	    Tta_txt = Math.floor(openOfficeMod(Pta_raw * 1000, 1000)).toString().padStart(3, '0') + " Tta)";
      Pta_txt = Math.floor(openOfficeMod(Pta_raw, 100)).toString().padStart(2, '0') + " Pta ";
    }

    if (bullysellect.value == 4) {
	    Tta_txt = Math.floor(openOfficeMod((Pta_raw / 100) * 16**4,16**4)).toString(16).toUpperCase().padStart(4, '0') + " hex)";
      Pta_txt = "";
    }

    let Pta_dec = openOfficeMod(openOfficeMod(Pta_raw, 100) + 100, 100);
    Pta = ((Pta_raw - Pta_dec) / 100) + anchor_byte1;

    let Pta_hex1 = openOfficeMod(openOfficeMod(Pta, 16**4) + 16**4, 16**4);
    Pta = ((Pta - Pta_hex1) / 16**4) + anchor_byte2;

    let Pta_hex2 = openOfficeMod(openOfficeMod(Pta, 16**4) + 16**4, 16**4);
    let Pta_hex3 = ((Pta - Pta_hex2) / 16**4) + anchor_byte3;

    document.getElementById('txt').innerHTML =  "<h1>" 
        + Pta_hex3.toString(16).toUpperCase().padStart(4, "0") 
        + " " + Pta_hex2.toString(16).toUpperCase().padStart(4, "0") 
        + " " + Pta_hex1.toString(16).toUpperCase().padStart(4, "0")
        + " <small>(+ " + Pta_txt + Tta_txt + "</small></h1>";

    // Update each user-selected time zone
    timezones.forEach(tz => {
        const select = document.getElementById(`select-${tz.id}`);
        const display = document.getElementById(`display-${tz.id}`);
        const selectedTimezone = select.value;

        if (selectedTimezone === 'TAI') {
            const taiTime = new Date(now.getTime() + TAI_UTC_OFFSET_MILLISECONDS);
            display.textContent = `${formatTimeWithDate(taiTime, 'UTC', use12hr, fracSecDig)} (TAI)`;
        } else if (selectedTimezone === 'TT') {
            const taiTime = new Date(now.getTime() + TAI_UTC_OFFSET_MILLISECONDS);
            const ttTime = new Date(taiTime.getTime() + TT_TAI_OFFSET_MILLISECONDS);
            display.textContent = `${formatTimeWithDate(ttTime, 'UTC', use12hr, fracSecDig)} (TT)`;
        } else {
            display.textContent = formatTimeWithDate(now, selectedTimezone, use12hr, fracSecDig);
        }
    });

    if (timeModeSelect.value === "current") {
        animationFrameId = requestAnimationFrame(updateTimestamps);
    }
  }

  function handleTimeModeChange() {
      if (timeModeSelect.value === "user-selected") {
          userTimeInput.style.display = "block";
          if (animationFrameId) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
          }
          updateTimestamps();
      } else {
          userTimeInput.style.display = "none";
          updateTimestamps();
      }
  }
  
  function initTimestamps() {
    createTimeZoneSelectors();
    updateTimestamps();

    // Event listeners
    timeModeSelect.addEventListener('change', handleTimeModeChange);
    userTimeInput.addEventListener('change', updateTimestamps);
    bullysellect.addEventListener('change', updateTimestamps);
  }

  function createTimeZoneSelectors() {
    const container = document.getElementById('timezone-displays');
    timezones.forEach(tz => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'timezone-item';
        
        const label = document.createElement('label');
        label.textContent = tz.name + ":";
        
        const select = document.createElement('select');
        select.id = `select-${tz.id}`;
        
        fullTimeZoneList.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.value;
            option.textContent = zone.label;
            if (zone.value === tz.default) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        const displayDiv = document.createElement('div');
        displayDiv.id = `display-${tz.id}`;
        displayDiv.style.marginLeft = '10px';
        displayDiv.textContent = 'Loading...';
        
        itemDiv.appendChild(label);
        itemDiv.appendChild(select);
        itemDiv.appendChild(displayDiv);
        container.appendChild(itemDiv);
    });
  }

  </script>
</body>
</html>
